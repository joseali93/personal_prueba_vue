<template>
  <b-container>
    <b-card>
      <b-card-body>
        <b-row class="float-right">
          <b-btn variant="outline-success" @click="nuevocl">
            <i class="fa fa-plus"></i>
          </b-btn>
          <b-btn variant="outline-success"  @click="refrescarCentrosLogisticos()">
            <i class="fa fa-refresh"></i>                              
          </b-btn>
        </b-row>
        <b-row>
          <b-input-group class="mb-3">
          <b-form-input v-model="CentroL"
          type="text"
          placeholder="Ingrese el nombre del Centro de Logistico">
          </b-form-input>
         
        </b-input-group>
        </b-row>
        <b-row>
          <b-table striped hover :items="centrosLogisticos" 
          :fields="fields"
           :filter="CentroL">
            <template slot="editar" slot-scope="data">
              <i class="btn btn-success fa fa-pencil" @click="editar(data)"></i>
            </template>
          </b-table>
        </b-row>
        
        

      </b-card-body>
    </b-card>
    <!-- Modal Nuevo Centro Logistico -->
    <b-modal id="ModalNuevo" size="lg" ref="ModalNuevo"
      no-close-on-backdrop
      no-close-on-esc		>
      <b-container fluid>
        <b-row class="mb-3">
          <b-col sm="3"><label for="Nnombre">Nombre Centro Logistico</label></b-col>
          <b-col sm="9">
            <b-form-input id="Nnombre" type="text" v-model="ModalNew.nombre"
            :state="statusnombre"
            @input=" ValidarTexto('Nnombre','nuevo')"
            maxlength="100"></b-form-input>
          </b-col>
          </b-row>
          <b-row class="mb-3">
            <b-col sm="3"><label for="Ndireccion">Dirección</label></b-col>
            <b-col sm="9"><b-form-input id="Ndireccion" type="text" v-model="ModalNew.direccion"
            :state="statusdireccion"
            @input=" ValidarTexto('Ndireccion','nuevo')"
            maxlength="100"></b-form-input></b-col>
          </b-row>
          <b-row class="mb-3">
            <b-col sm="3"><label for="Nciudad">Ciudad</label></b-col>
            <b-col sm="9"><b-form-input id="Nciudad" type="text" v-model="ModalNew.ciudad"
            :state="statusciudad"
            @input=" ValidarTexto('Nciudad','nuevo')"
            maxlength="100"></b-form-input></b-col>
          </b-row>
          <b-row class="mb-3">
            <b-col sm="3"><label for="Npais">Pais</label></b-col>
            <b-col sm="9"><b-form-input id="Npais" type="text" v-model="ModalNew.pais"
            :state="statuspais"
            @input=" ValidarTexto('Npais','nuevo')"
            maxlength="100"></b-form-input></b-col>
          </b-row>
      </b-container>
      <div slot="modal-footer" class="w-100">
        <b-btn size="sm" class="float-right" variant="primary" @click="CrearNuevoCL()">
        Guardar
        </b-btn>
        <b-btn size="sm" class="float-left" variant="danger" @click="cerrarModal()">
        Cerrar
        </b-btn>
      </div>
      <div slot="modal-header" class="w-100">
        <strong >Crear Centro Logistico</strong>
        <b-btn size="sm" class="float-right" variant="outline-danger" @click="cerrarModal()">
        X
        </b-btn>
      </div>
    </b-modal>
    <!-- Modal Editar Centro Logistico -->
    <b-modal id="ModalEditar" ref="ModalEditar" size="lg"
      no-close-on-backdrop
      no-close-on-esc>
     <b-container fluid>
        <b-row class="mb-3">
          <b-col sm="3"><label for="NnombreED">Nombre Centro Logistico</label></b-col>
          <b-col sm="9">
            <b-form-input id="NnombreED" type="text" v-model="ModalEdit.nombre"
            :state="statusnombre"
            @input=" ValidarTexto('NnombreED','editar')"
            maxlength="100"></b-form-input>
          </b-col>
          </b-row>
          <b-row class="mb-3">
            <b-col sm="3"><label for="NdireccionED">Dirección</label></b-col>
            <b-col sm="9"><b-form-input id="NdireccionED" type="text" v-model="ModalEdit.direccion"
            :state="statusdireccion"
            @input=" ValidarTexto('NdireccionED','editar')"
            maxlength="100"></b-form-input></b-col>
          </b-row>
          <b-row class="mb-3">
            <b-col sm="3"><label for="NciudadED">Ciudad</label></b-col>
            <b-col sm="9"><b-form-input id="NciudadED" type="text" v-model="ModalEdit.ciudad"
            :state="statusciudad"
            @input=" ValidarTexto('NciudadED','editar')"
            maxlength="100"></b-form-input></b-col>
          </b-row>
          <b-row class="mb-3">
            <b-col sm="3"><label for="NpaisED">Pais</label></b-col>
            <b-col sm="9"><b-form-input id="NpaisED" type="text" v-model="ModalEdit.pais"
            :state="statuspais"
            @input=" ValidarTexto('NpaisED','editar')"
            maxlength="100"></b-form-input></b-col>
          </b-row>
      </b-container>
      <div slot="modal-footer" class="w-100">
        <b-btn size="sm" class="float-right" variant="primary" @click="ActualizarCentroLogistico()">
        Guardar
        </b-btn>
        <b-btn size="sm" class="float-left" variant="danger" @click="cerrarModal()">
        Cerrar
        </b-btn>
      </div>
      <div slot="modal-header" class="w-100">
        <strong >Actualizar Centro Logistico</strong>
        <b-btn size="sm" class="float-right" variant="outline-danger" @click="cerrarModal()">
        X
        </b-btn>
      </div>
    </b-modal>
  </b-container>
</template>

<script>
import { urlservicios } from "../main";

export default {
  data() {
    return {
      statusciudad: null,
      statusdireccion: null,
      statusnombre: null,
      statuspais: null,
      CentroL: "",
      ModalNew: {
        ciudad: "",
        direccion: "",
        nombre: "",
        pais: ""
      },
      ModalEdit: {},
      centrosLogisticos: [],
      fields: [
        { key: "ciudad", label: "Ciudad", sortable: false },
        { key: "nombre", label: "Nombre", sortable: false },
        { key: "direccion", label: "Dirección", sortable: false },
        { key: "editar", label: "Editar", sortable: false }
      ]
    };
  },
  methods: {
    ActualizarCentroLogistico() {
      console.log("actualizar");
      if (
        this.ModalEdit.nombre == "" ||
        this.ModalEdit.direccion == "" ||
        this.ModalEdit.ciudad == "" ||
        this.ModalEdit.pais == ""
      ) {
        if (this.ModalEdit.nombre == "") {
          this.statusnombre = false;
        }
        if (this.ModalEdit.direccion == "") {
          this.statusdireccion = false;
        }
        if (this.ModalEdit.ciudad == "") {
          this.statusciudad = false;
        }
        if (this.ModalEdit.pais == "") {
          this.statuspais = false;
        }
        swal(
          "Error!",
          "Para Actualizar deben estar completos todos los campos",
          "error"
        );
      }
      if( this.statusnombre==false||
      this.statusdireccion==false||
      this.statuspais==false||
      this.statusciudad==false){
        swal(
          'Error!',
          'Para Actualizar debe cumplirse el formato establecido',
          'error'
          )
      }
      else{
        var objeto ={
                nombre:this.ModalEdit.nombre,
                direccion:this.ModalEdit.direccion,
                pais:this.ModalEdit.pais,
                ciudad:this.ModalEdit.ciudad,
                }
        this.$refs.ModalEditar.hide()
                /*
        this.axios.post(urlservicios+"ActulizarCliente/"+this.ModalEdit._id,objeto)
                    .then((response) => {
                    
                        console.log(response);

                        if(response.data.validar==true)
                        {
                            swal({
                            title: 'Actualizado Exitosamente',
                            timer: 1500,
                            type:'success'})
                            this.$refs.modalEditar.hide()

                        }else{
                            swal({
                            title: 'No se pudo actualizar',
                            timer: 1000,
                            type:'error'})
                        }
                        
                    })
                    */
      }
    },
    editar(value) {
      console.log(value);
      this.ModalEdit = value.item;
      this.$refs.ModalEditar.show();
    },
    ValidarTexto(id, accion) {
      var key, tecla, tecla_especial, letras, especiales;
      var e = document.getElementById(eval("id")).value;
      console.log(id);

      if (accion == "nuevo") {
        if (id == "Ndireccion") {
          if (e.match(/^[0-9a-zA-Z\s\#\-]+$/)) {
            if (e.length >= 100) {
              this.statusdireccion = false;
            } else {
              this.statusdireccion = null;
            }
          } else {
            this.statusdireccion = false;
          }
        }
        if (e.match(/^[0-9a-zA-Z\s\-]*$/)) {
          if (id == "Nnombre") {
            if (e.length > 99) {
              this.statusnombre = false;
            } else {
              this.statusnombre = null;
            }
          }

          if (id == "Nciudad") {
            if (e.length > 100) {
              this.statusciudad = false;
            } else {
              this.statusciudad = null;
            }
          }
          if (id == "Npais") {
            if (e.length > 100) {
              this.statuspais = false;
            } else {
              this.statuspais = null;
            }
          }
        } else {
          if (id == "Nnombre") {
            this.statusnombre = false;
          }

          if (id == "Nciudad") {
            this.statusciudad = false;
          }
          if (id == "Npais") {
            this.statuspais = false;
          }
        }
      }
      if (accion == "editar") {
        if (id == "NnombreED") {
          if (this.ModalEdit.nombre.match(/^[0-9a-zA-Z\s\-]*$/)) {
            if (this.ModalEdit.nombre.length >= 100) {
              this.statusnombre = false;
            } else {
              this.statusnombre = null;
            }
          } else {
            if (id == "NnombreED") {
              this.statusnombre = false;
            }
          }
        }
        if (id == "Ndireccion") {
          if (this.ModalEdit.direccion.match(/^[0-9a-zA-Z\s\#\-]+$/)) {
            if (this.ModalEdit.direccion.length >= 100) {
              this.statusdireccion = false;
            } else {
              this.statusdireccion = null;
            }
          } else {
            this.statusdireccion = false;
          }
        }
        if (id == "NciudadED") {
          if (this.ModalEdit.ciudad.match(/^[0-9a-zA-Z\s\-]*$/)) {
            if (this.ModalEdit.ciudad.length >= 100) {
              this.statusciudad = false;
            } else {
              this.statusciudad = null;
            }
          } else {
            if (id == "NciudadED") {
              this.statusciudad = false;
            }
          }
        }
        if (id == "NpaisED") {
          if (this.ModalEdit.pais.match(/^[0-9a-zA-Z\s\-]*$/)) {
            if (this.ModalEdit.pais.length >= 100) {
              this.statuspais = false;
            } else {
              this.statuspais = null;
            }
          } else {
            if (id == "NpaisED") {
              this.statuspais = false;
            }
          }
        }
      }
    },
    cerrarModal() {
      console.log("cerrar modal");
      this.ModalNew.ciudad = "";
      this.ModalNew.direccion = "";
      this.ModalNew.nombre = "";
      this.ModalNew.pais = "";
      this.statusciudad= null,
      this.statusdireccion= null,
      this.statusnombre= null,
      this.statuspais= null,
      this.$refs.ModalNuevo.hide();
      this.$refs.ModalEditar.hide();
    },
    refrescarCentrosLogisticos() {
      var test2 = localStorage.getItem("storedData");
      var test = JSON.parse(test2);
      var id_cliente;
      id_cliente = "null";
      this.axios
        .get(
          urlservicios + "centroslogisticos/" + test.id_OperadorLogistico._id
        )
        .then(response => {
          console.log(response);
          this.centrosLogisticos = response.data;
        });
    },
    nuevocl() {
      this.ModalNew.nombre=this.CentroL
      this.$refs.ModalNuevo.show();
    },
    CrearNuevoCL() {
      console.log("guardo");
      var test2 = localStorage.getItem("storedData");
      var test = JSON.parse(test2);
      var objeto;
      var bandera;
      objeto = this.ModalNew;
      if (
        this.ModalNew.nombre == "" ||
        this.ModalNew.direccion == "" ||
        this.ModalNew.ciudad == "" ||
        this.ModalNew.pais == ""
      ) {
        if (this.ModalNew.nombre == "") {
          this.statusnombre = false;
        }
        if (this.ModalNew.direccion == "") {
          this.statusdireccion = false;
        }
        if (this.ModalNew.ciudad == "") {
          this.statusciudad = false;
        }
        if (this.ModalNew.pais == "") {
          this.statuspais = false;
        }
        swal(
          "Error!",
          "Para Actualizar deben estar completos todos los campos",
          "error"
        );
      }
      if( this.statusnombre==false||
        this.statusdireccion==false||
        this.statuspais==false||
        this.statusciudad==false){
        swal(
          'Error!',
          'Para la Creación debe cumplirse el formato establecido',
          'error'
          )
      }
      else {
        var objenvio = {
          nombre: objeto.nombre,
          direccion: objeto.direccion,
          ciudad: objeto.ciudad,
          pais: objeto.pais,
          id_operadorlogistico: test.id_OperadorLogistico._id
        };
        console.log(objenvio);

        this.axios
          .post(urlservicios + "CrearCentrosLogisticos/", objenvio)
          .then(response => {
            console.log(response.data);
          });
      }
    }
  },

  created: function() {
    var test2 = localStorage.getItem("storedData");
    var test = JSON.parse(test2);
    var id_cliente;
    id_cliente = "null";

    this.axios
      .get(urlservicios + "centroslogisticos/" + test.id_OperadorLogistico._id)
      .then(response => {
        console.log(response.data);
        this.centrosLogisticos = response.data;
      });
  }
};
</script>

<style>

</style>
